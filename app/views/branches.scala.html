@(branches: Iterable[models.Branch])(implicit request: RequestHeader)

@import models.Entity

@import components.entityState


<div class="container">

    <table class="table sortable table-striped table-condensed">
        <thead>
            <tr>
                <th>Pull Request</th>
                <th>Branch</th>
                <th>Name</th>
                <th>Users</th>
                <th data-defaultsort="asc">State</th>
            </tr>
        </thead>
        <tbody>
        @for(branch <- branches) {
            @branch.builds match {
                case head::tail => {
                    @head.result match {
                        case BuildResult.SUCCESS => {
                            <tr class="success">
                        }
                        case BuildResult.FAILURE => {
                            <tr class="danger">
                        }
                        case _ => {
                            <tr class="warning">
                        }
                    }
                }
                case _ => {
                    <tr>
                }
            }
                <td>@branch.pullRequest match {
                    case Some(pr) => {
                        <a class="btn btn-default pull-request" data-id="@pr.id" href="@pr.url">#@pr.id</a>
                    }
                    case None => {}
                    }
                </td>
                <td>@branch.name</td>
                @branch.entity match {
                    case Some(entity) => {
                        <td><small>@entity.name</small></td>
                        <td data-value="@entity.sortedAssignments.map(_.lastName).mkString(" ")">
                            @for(assignment <- entity.sortedAssignments) {
                                <span data-role="@assignment.role" class="role @if(assignment.isResponsible){role-active}else{role-inactive}"><img data-src="holder.js/100%x180" src="@{
                                    assignment.avatar
                                }30"
                                title="@assignment.role: @assignment.fullName">
                                    </span>
                                }
                        </td>
                        @entityState(entity.id, entity.state)
                    }
                    case None => {
                        <td></td>
                        <td></td>
                        <td></td>
                    }
                }
            </tr>
        }
        </tbody>
    </table>
</div><!-- /.container -->
<script>
    $ ('.pull-request' ).each(function(){
        var $a = $(this);
        var id = $a.data('id');
        if (id){
            jsRoutes.controllers.Github.pullRequestStatus(id).ajax().done(function(resp){
                var isMerged = resp.isMerged;
                var isMergeable = resp.isMergeable;
                $a.removeClass('btn-default');
                if (isMerged){
                    $a.addClass('btn-primary');
                } else if (isMergeable){
                    $a.addClass('btn-success');
                } else {
                    $a.addClass('btn-danger');
                }
            });
        }
    });

    $ ('tr' ).on('click', '.role-change-state', function(e){
        e.preventDefault();
        var $nextState= $(this);

    var $button = $nextState.closest('.role-next-states-group').find('.role-next-states-trigger' );
        $button.attr('disabled','disabled');

        var entityStateId = $nextState.data("stateId");
        var entityId = $nextState.data("entityId");

        jsRoutes.controllers.Targetprocess.changeEntityState(entityId, entityStateId ).ajax( ).done(function(newState){
            $nextState.closest('td.role-state' ).replaceWith(newState.text);
        });




    })
</script>